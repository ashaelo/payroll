# Payslip Design Customization - Implementation Plan

This document outlines the plan to implement a "Payslip Design" feature within the settings page of the PayrollPro application. This will allow users to customize the visual appearance of generated payslips.

## 1. Core Features to Implement

The initial implementation will focus on the following core customization options:

*   **Primary Color**: For payslip headers, important text, and borders.
*   **Background Color**: For the main payslip background.
*   **Header Layout**: Options for logo positioning (e.g., Logo Left, Logo Right, Logo Center).
*   **Field Visibility**: Toggles to show/hide:
    *   Employee ID
    *   Department
    *   Position
*   **Custom Footer Text**: Allow users to define a custom footer line.
*   **Simple Preview**: A basic visual representation of the payslip design within the settings page that updates as options are changed.

## 2. Default Payslip Design Settings

The following default values will be used:

*   `payslipPrimaryColor`: `#003366` (Dark Blue)
*   `payslipBackgroundColor`: `#FFFFFF` (White)
*   `payslipHeaderLayout`: `logoLeft`
*   `payslipShowEmployeeID`: `true`
*   `payslipShowDepartment`: `true`
*   `payslipShowPosition`: `true`
*   `payslipFooterText`: `Generated by PayrollPro - Your Company Name`

## 3. Implementation Steps

### Step 1: Extend AppSettings Context and Provider

**File**: `frontend/src/App.tsx` (within `AppSettingsContextType` and `AppSettingsProvider`)

1.  **Define `PayslipDesignSettings` Interface**:
    ```typescript
    interface PayslipDesignSettings {
      primaryColor: string;
      backgroundColor: string;
      headerLayout: 'logoLeft' | 'logoRight' | 'logoCenter';
      showEmployeeID: boolean;
      showDepartment: boolean;
      showPosition: boolean;
      footerText: string;
    }
    ```

2.  **Update `AppSettingsContextType`**:
    Add `payslipDesign: PayslipDesignSettings;`
    Add `setPayslipDesign: (settings: PayslipDesignSettings) => void;`
    Add `resetPayslipDesignSettings: () => void;`

3.  **Update `AppSettingsProvider` State**:
    *   Add state for `payslipDesign` initialized with default values:
        ```typescript
        const initialPayslipDesignSettings: PayslipDesignSettings = {
          primaryColor: '#003366',
          backgroundColor: '#FFFFFF',
          headerLayout: 'logoLeft',
          showEmployeeID: true,
          showDepartment: true,
          showPosition: true,
          footerText: `Generated by ${systemName}`, // Use dynamic system name
        };
        const [payslipDesign, setPayslipDesignState] = useState<PayslipDesignSettings>(initialPayslipDesignSettings);
        ```
    *   Update the `useEffect` for loading initial settings to include `payslipDesignSettings` from `localStorage` (and conceptually from `/api/company` if backend stores it).
        ```typescript
        // Inside AppSettingsProvider useEffect
        const storedPayslipDesign = localStorage.getItem('payrollPayslipDesign');
        if (storedPayslipDesign) {
          setPayslipDesignState(JSON.parse(storedPayslipDesign));
        } else {
          // Update footer text with current system name if no stored settings
           setPayslipDesignState(prev => ({...prev, footerText: `Generated by ${systemName}`}));
        }

        // When loading from /api/company, check for payslip design fields
        // if (response.data.payslip_design_settings) {
        //   setPayslipDesignState(prev => ({...prev, ...response.data.payslip_design_settings}));
        // }
        ```
    *   Implement `setPayslipDesign` function:
        ```typescript
        const setPayslipDesign = (settings: PayslipDesignSettings) => {
          setPayslipDesignState(settings);
          localStorage.setItem('payrollPayslipDesign', JSON.stringify(settings));
        };
        ```
    *   Implement `resetPayslipDesignSettings` function:
        ```typescript
        const resetPayslipDesignSettings = () => {
          const defaultsWithSystemName = {...initialPayslipDesignSettings, footerText: `Generated by ${systemName}`};
          setPayslipDesignState(defaultsWithSystemName);
          localStorage.setItem('payrollPayslipDesign', JSON.stringify(defaultsWithSystemName));
        };
        ```
    *   Provide `payslipDesign`, `setPayslipDesign`, and `resetPayslipDesignSettings` in the context value.

### Step 2: Add "Payslip Design" Tab to Settings Page

**File**: `frontend/src/App.tsx` (within `SettingsPage` component)

1.  **Update `TABS` Array**:
    Add a new tab:
    ```typescript
    { id: 'payslip_design', label: 'Payslip Design' },
    ```
    Ensure it's placed logically (e.g., after 'Branding' or 'Preferences').

### Step 3: Create Form for Payslip Design in Settings

**File**: `frontend/src/App.tsx` (within `SettingsPage` component, `renderTabContent` function)

1.  **Add a new `case` for `'payslip_design'`**:
2.  **Use `useAppSettings()`** to get `payslipDesign` and `setPayslipDesign`, `resetPayslipDesignSettings`.
3.  **Local Form State**: Create a local state `payslipDesignForm` initialized from `payslipDesign` context value.
    ```typescript
    const [payslipDesignForm, setPayslipDesignForm] = useState<PayslipDesignSettings>(payslipDesign);

    useEffect(() => { // Keep form in sync with context if context changes (e.g. reset)
        setPayslipDesignForm(payslipDesign);
    }, [payslipDesign]);
    ```
4.  **Implement Form Fields**:
    *   **Primary Color**: `<input type="color" value={payslipDesignForm.primaryColor} onChange={...} />`
    *   **Background Color**: `<input type="color" value={payslipDesignForm.backgroundColor} onChange={...} />`
    *   **Header Layout**: Radio buttons or select for `logoLeft`, `logoRight`, `logoCenter`.
        ```html
        <label style={styles.label}>Header Layout:</label>
        <div>
          <label><input type="radio" name="headerLayout" value="logoLeft" checked={payslipDesignForm.headerLayout === 'logoLeft'} onChange={handleFormChange} /> Logo Left, Info Right</label>
          <label><input type="radio" name="headerLayout" value="logoRight" checked={payslipDesignForm.headerLayout === 'logoRight'} onChange={handleFormChange} /> Info Left, Logo Right</label>
          <label><input type="radio" name="headerLayout" value="logoCenter" checked={payslipDesignForm.headerLayout === 'logoCenter'} onChange={handleFormChange} /> Logo & Info Centered</label>
        </div>
        ```
    *   **Field Visibility**: Checkboxes for `showEmployeeID`, `showDepartment`, `showPosition`.
        ```html
        <label style={styles.label}><input type="checkbox" name="showEmployeeID" checked={payslipDesignForm.showEmployeeID} onChange={handleFormChange} /> Show Employee ID</label>
        // ... similar for department and position
        ```
    *   **Custom Footer Text**: `<input type="text" value={payslipDesignForm.footerText} onChange={...} />`
5.  **Simple Preview Area**:
    *   Create a `div` that roughly mimics the payslip structure.
    *   Apply styles dynamically based on `payslipDesignForm` state (primary color for a header div, background color for the main div, etc.).
    *   Show/hide placeholder text for Employee ID, Department, Position based on toggles.
    *   Display the custom footer text.
    *   Example structure:
        ```html
        <div style={{ border: '1px solid #ccc', padding: '10px', marginTop: '20px', backgroundColor: payslipDesignForm.backgroundColor }}>
            <div style={{ backgroundColor: payslipDesignForm.primaryColor, color: '#fff', padding: '5px', textAlign: 'center' }}>
                Header Preview (Logo: {payslipDesignForm.headerLayout})
            </div>
            <p style={{ fontSize: '10px', marginTop: '5px' }}>Employee Details:</p>
            {payslipDesignForm.showEmployeeID && <p style={{ fontSize: '10px' }}>ID: EMP123</p>}
            {/* ... other preview elements ... */}
            <div style={{ marginTop: '10px', paddingTop: '5px', borderTop: '1px solid #ccc', fontSize: '9px', textAlign: 'center', color: payslipDesignForm.primaryColor }}>
                {payslipDesignForm.footerText}
            </div>
        </div>
        ```
6.  **Save and Reset Buttons**:
    *   "Save Payslip Design" button: Calls `handleSave('payslip_design')`.
    *   "Reset to Defaults" button: Calls `resetPayslipDesignSettings()` from context.

7.  **Update `handleSave` in `SettingsPage`**:
    *   Add a case for `'payslip_design'`:
        ```typescript
        // Inside handleSave
        case 'payslip_design':
          setPayslipDesign(payslipDesignForm); // Update context
          // Conceptually, also include payslipDesignForm in the payload to /api/company
          // For now, context update + localStorage persistence is primary
          // Example of merging with company settings for backend save:
          // const fullCompanyPayload = { ...companyInfo, ...brandingForm, payslip_design: payslipDesignForm };
          // await apiClient.post('/company', fullCompanyPayload); 
          alert('Payslip design settings saved!');
          break;
        ```
    *   When saving from 'branding' or 'company' tabs, ensure the current `payslipDesign` settings from context are also included in the payload sent to `/api/company` so the backend can store them.
        ```typescript
        // Example for 'branding' save:
        // payload = { ...companyInfo, system_name: brandingForm.systemName, tagline: brandingForm.tagline, system_logo: newLogoDataUrl || systemLogo, system_currency: currency, payslip_design: payslipDesign };
        // await apiClient.post(endpoint, payload);
        ```

### Step 4: Update PayslipsPage to Use Design Settings

**File**: `frontend/src/App.tsx` (within `PayslipsPage` component)

1.  **Use `useAppSettings()`**: Get `payslipDesign` settings from context.
2.  **Dynamically Style Payslip**:
    *   Apply `payslipDesign.primaryColor` to headers, borders, important text elements.
    *   Apply `payslipDesign.backgroundColor` to the main payslip container (`#printable-payslip`).
    *   Implement `payslipDesign.headerLayout`:
        *   Use flexbox properties (`flexDirection`, `justifyContent`, `order`) on the payslip header div to position logo and company info.
    *   Conditionally render Employee ID, Department, and Position based on `payslipDesign.showEmployeeID`, `payslipDesign.showDepartment`, `payslipDesign.showPosition`.
    *   Display `payslipDesign.footerText` in the payslip footer.
    *   Example for conditional rendering:
        ```typescript jsx
        // In payslip employee info table
        {payslipDesign.showEmployeeID && (
            <tr>
                <td style={{padding:'6px 4px', fontWeight:'bold'}}>Employee ID:</td>
                <td style={{padding:'6px 4px'}}>{selectedEmployee}</td>
            </tr>
        )}
        ```
    *   Update the inline styles of the `#printable-payslip` div and its children to use these dynamic settings. For example:
        ```typescript jsx
        // Payslip Container
        <div id="printable-payslip" style={{
            maxWidth: 700, margin: '30px auto', padding: 25, 
            border: `1px solid ${payslipDesign.primaryColor}`, // Use primary color for border
            borderRadius: 8, fontFamily: 'Arial, sans-serif', 
            color: '#000', // Base text color
            background: payslipDesign.backgroundColor // Use background color
        }}>
            {/* Header Section */}
            <div style={{
                display:'flex', 
                justifyContent: payslipDesign.headerLayout === 'logoCenter' ? 'center' : 'space-between', 
                flexDirection: payslipDesign.headerLayout === 'logoCenter' ? 'column' : 'row',
                alignItems:'center', marginBottom: 25, paddingBottom: 15, 
                borderBottom: `2px solid ${payslipDesign.primaryColor}` // Use primary color
            }}>
                <div style={{
                    width: 120, height: 60, border: '1px solid #ccc', 
                    borderRadius: 4, display:'flex', alignItems:'center', 
                    justifyContent:'center', fontSize:12, color:'#777', 
                    backgroundColor: '#f0f0f0',
                    order: payslipDesign.headerLayout === 'logoRight' ? 2 : 1, // Example for layout
                }}>
                    {systemLogo ? <img src={systemLogo} alt="Logo" style={styles.sidebarLogoImg} /> : 'Company Logo'}
                </div>
                <div style={{textAlign: payslipDesign.headerLayout === 'logoCenter' ? 'center' : (payslipDesign.headerLayout === 'logoLeft' ? 'right' : 'left'), order: payslipDesign.headerLayout === 'logoRight' ? 1 : 2}}>
                    <h2 style={{margin:0, padding:0, fontSize: 22, color: payslipDesign.primaryColor}}>{systemName}</h2>
                    <p style={{margin:0,fontSize:13, color: '#555'}}>{tagline}</p>
                    {/* Add company address/tax no from companyInfo context if needed */}
                </div>
            </div>
            {/* ... rest of payslip structure ... */}
             <div style={{marginTop:30, fontSize:11, textAlign:'center', color: payslipDesign.primaryColor}}>
                {payslipDesign.footerText}
            </div>
        </div>
        ```

### Step 5: Backend Update (Conceptual - for simple-server.js)

**File**: `backend/simple-server.js`

1.  **Extend `companySettings` Object**: Add fields for payslip design customization.
    ```javascript
    let companySettings = {
      // ... existing fields ...
      system_currency: 'ZWD',
      payslip_design: { // New object for payslip settings
        primaryColor: '#003366',
        backgroundColor: '#FFFFFF',
        headerLayout: 'logoLeft',
        showEmployeeID: true,
        showDepartment: true,
        showPosition: true,
        footerText: 'Generated by PayrollPro',
      }
    };
    ```
2.  **Update `/api/company` POST Endpoint**:
    *   When saving company settings, also save `payslip_design` object if present in the request body.
    ```javascript
    // Inside app.post('/api/company', ...)
    const { /* ...other fields..., */ payslip_design } = req.body;
    // ... update other companySettings ...
    if (payslip_design) {
        companySettings.payslip_design = { ...companySettings.payslip_design, ...payslip_design };
    }
    ```
    This ensures that if the frontend sends payslip design settings along with other company info, they are saved.

## 4. User Experience Considerations

*   **Professional Interface**: The new settings tab and form elements should match the existing professional styling.
*   **Simple Preview**: The preview should give a good-enough visual indication of the changes. A full, live, pixel-perfect preview is complex with inline styles and is out of scope for this focused implementation.
*   **Save/Reset Buttons**: Clearly visible and functional for the "Payslip Design" tab.
*   **Professional Defaults**: Ensure the default design is clean and professional.

This plan provides a focused approach to implementing the core payslip design customization features. Further enhancements like more advanced layout options or font choices can be added in subsequent iterations.
